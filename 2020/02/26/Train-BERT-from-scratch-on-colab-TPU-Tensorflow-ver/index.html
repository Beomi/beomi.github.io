<!DOCTYPE html>
<html  lang="ko">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.1" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Colabì—ì„œ TPUë¡œ BERT ì²˜ìŒë¶€í„° í•™ìŠµì‹œí‚¤ê¸° - Tensorflow/Google ver. - Beomi&#39;s Tech blog</title>








<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-89162642-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-89162642-1');
</script>

    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    


<link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body class="is-2-column">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                Beomi&#39;s Tech Blog
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="https://junbuml.ee">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="ì¹´íƒˆë¡œê·¸" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-image">
        <span  class="image is-7by1">
            <img class="thumbnail" src="https://d1sr4ybm5bj1wl.cloudfront.net/img/2020-02-25-081414.jpg" alt="Colabì—ì„œ TPUë¡œ BERT ì²˜ìŒë¶€í„° í•™ìŠµì‹œí‚¤ê¸° - Tensorflow/Google ver.">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-02-25T15:00:00.000Z">2020-02-26</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/NLP/">NLP</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/NLP/LanguageModel/">LanguageModel</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/NLP/LanguageModel/BERT/">BERT</a>
                </div>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Colabì—ì„œ TPUë¡œ BERT ì²˜ìŒë¶€í„° í•™ìŠµì‹œí‚¤ê¸° - Tensorflow/Google ver.
            
        </h1>
        <div class="content">
            <p>2018ë…„ë§ë¶€í„° í˜„ì¬ê¹Œì§€ NLP ì—°êµ¬ì—ì„œ BERTëŠ” ì—¬ì „íˆ ì••ë„ì ì¸ ìœ„ì¹˜ë¥¼ ì°¨ì§€í•˜ê³  ìˆë‹¤.</p>
<p>í•œí¸, BERTëª¨ë¸ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ  ì¤‘ ê°€ì¥ í° ê²ƒ í•˜ë‚˜ê°€ ë°”ë¡œ <strong>í•œêµ­ì–´ë¡œ Pretrainedëœ ëª¨ë¸ì´ ìˆë‹¤</strong>ëŠ” ì ì´ë‹¤. Googleì—ì„œ ë…¼ë¬¸ì„ ì²˜ìŒ ê³µê°œí–ˆì„ ë•Œ Multilingual pretrained modelì„ ê³µê°œí•´ Fine-tuningë§Œìœ¼ë¡œë„ ìš°ë¦¬ê°€ í•„ìš”í•œ ë°ì´í„°ì…‹ì— ë§ì¶° ë¶„ë¥˜ê¸°ë¥¼ ë§Œë“œëŠ” ë“±ì˜ ì—¬ëŸ¬ ì‘ìš©ì´ ê°€ëŠ¥í•˜ê³ , ë™ì‹œì— <strong>ë†’ì€ ì„±ëŠ¥</strong>ì„ ë³´ì—¬ì£¼ì—ˆê¸° ë•Œë¬¸ì— BERT ìì²´ë¥¼ í•™ìŠµì‹œí‚¤ëŠ” ê²ƒì— ëŒ€í•´ì„œëŠ” í¬ê²Œ ì‹ ê²½ì“°ì§€ ì•Šì€ ê²ƒì´ ì‚¬ì‹¤ì´ë‹¤.</p>
<p>í•œí¸ ì‘ë…„ <a href="http://aiopen.etri.re.kr/service_dataset.php">ETRIì˜ í•œêµ­ì–´ BERT ì–¸ì–´ëª¨ë¸</a>, ê·¸ë¦¬ê³  <a href="https://github.com/SKTBrain/KoBERT">SKTBrainì˜ KoBERT</a> ë“± í•œêµ­ì–´ ë°ì´í„°ì…‹ìœ¼ë¡œ í•™ìŠµì‹œí‚¨ ëª¨ë¸ë“¤ì´ ë“±ì¥í–ˆê³ , ì´ëŸ° ëª¨ë¸ë“¤ì„ Fine-tuningí•  ê²½ìš° ê¸°ì¡´ êµ¬ê¸€ì˜ ë‹¤êµ­ì–´ ëª¨ë¸ì„ ì‚¬ìš©í•œ ê²ƒë³´ë‹¤ ì„±ëŠ¥ì´ ì¡°ê¸ˆì´ë¼ë„ ë” ì˜ ë‚˜ì˜¤ê¸°ë„ í•œë‹¤. (íŠ¹íˆ <strong>ì •ì œë˜ì§€ ì•Šì€</strong> ê¸€ì— ëŒ€í•´ ì¢€ ë” ë‚˜ì€ ì„±ëŠ¥ì„ ë³´ì—¬ì¤¬ë‹¤. OOVë¬¸ì œê°€ ëœí•œ í¸ì´ì—ˆë‹¤.)</p>
<p>ë‹¤ë§Œ ì´ëŸ° ëª¨ë¸ë“¤ ì—­ì‹œ êµ‰ì¥íˆ â€˜ë³´í¸ì â€™ ê¸€ë¡œ í•™ìŠµëœ ê²ƒì´ë¼ ë„ë©”ì¸ íŠ¹í™”ëœ ë¶„ì•¼ì— ìˆì–´ì„œëŠ” ì„±ëŠ¥ì´ ì˜ ë‚˜ì˜¤ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤. ë”°ë¼ì„œ <strong>íŠ¹ìˆ˜í•œ ê²½ìš°ì˜ íŠ¹ìˆ˜í•œ ë„ë©”ì¸ì— ìµœì í™”ëœ Pretrained modelì„ ë§Œë“ ë‹¤</strong>ë©´ ìš°ë¦¬ì˜ NLP ëª¨ë¸ë„ ì¢€ ë” ì„±ëŠ¥ì´ ì¢‹ì•„ì§ˆ ìˆ˜ ìˆë‹¤!</p>
<p>ì´ë²ˆ ê¸€ì—ì„œëŠ” BERT ëª¨ë¸ì„ TPUì™€ Tensorflowë¥¼ ì´ìš©í•´ ì²˜ìŒë¶€í„° í•™ìŠµì‹œì¼œë³´ëŠ” ê³¼ì •ì„ ë‹¤ë¤„ë³¸ë‹¤.</p>
<blockquote>
<p>ì´ë²ˆ ê¸€ì€ <a href="https://colab.research.google.com/drive/1nVn6AFpQSzXBt8_ywfx6XR8ZfQXlKGAz">Colab Notebook: Pre-training BERT from scratch with cloud TPU</a>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
</blockquote>
<a id="more"></a>

<h2 id="ì–´ë–¤-í™˜ê²½ì—ì„œ-ê°œë°œí•˜ë‚˜"><a href="#ì–´ë–¤-í™˜ê²½ì—ì„œ-ê°œë°œí•˜ë‚˜" class="headerlink" title="ì–´ë–¤ í™˜ê²½ì—ì„œ ê°œë°œí•˜ë‚˜?"></a>ì–´ë–¤ í™˜ê²½ì—ì„œ ê°œë°œí•˜ë‚˜?</h2><p>2020ë…„ 2ì›” 26ì¼ì ê¸°ì¤€ Google Colabì—ì„œ TPUë¥¼ í™œì„±í™” ì‹œí‚¨ ìƒíƒœì—ì„œ ì •ìƒì ìœ¼ë¡œ í•™ìŠµì´ ê°€ëŠ¥í•˜ë‹¤.</p>
<p>ë‹¨, GCP ì„œë¹„ìŠ¤ ì¤‘ Cloud Bucketì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— í™œì„±í™”ëœ GCP ê³„ì •ì´ í•„ìš”í•˜ë‹¤. (ê°€ì…í•˜ë©´ 1ë…„ ì“¸ ìˆ˜ ìˆëŠ” $300ì„ ì¤€ë‹¤!)</p>
<h2 id="ì¤€ë¹„ë¬¼"><a href="#ì¤€ë¹„ë¬¼" class="headerlink" title="ì¤€ë¹„ë¬¼"></a>ì¤€ë¹„ë¬¼</h2><ul>
<li>Google ê³„ì • &amp; êµ¬ê¸€ Colab</li>
<li>GCP Storage Bucket</li>
</ul>
<h2 id="í•„ìš”í•œ-ë¼ì´ë¸ŒëŸ¬ë¦¬-ì„¤ì¹˜í•˜ê¸°"><a href="#í•„ìš”í•œ-ë¼ì´ë¸ŒëŸ¬ë¦¬-ì„¤ì¹˜í•˜ê¸°" class="headerlink" title="í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜í•˜ê¸°"></a>í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜í•˜ê¸°</h2><p>BERTë¥¼ í•™ìŠµì‹œí‚¤ê¸° ìœ„í•´ì„œëŠ” Tokenizedëœ ë°ì´í„°ë¥¼ ë„£ì–´ì¤˜ì•¼ í•œë‹¤. ì´ë•Œ ìš°ë¦¬ëŠ” í† í¬ë‚˜ì´ì €ë¡œ <code>sentencepiece</code> ë¥¼ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!pip install sentencepiece</span><br><span class="line">!git <span class="built_in">clone</span> https://github.com/google-research/bert</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>sentencepiece</code> ëŒ€ì‹  <code>konlpy</code> ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</blockquote>
<p>ë˜í•œ, êµ¬ê¸€ ë¦¬ì„œì¹˜ì—ì„œ ê³µì‹ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” BERT Repoë¥¼ ë°›ì•„ì„œ ì“°ë©´ ëª¨ë¸ê³¼ ìµœì í™” ë“±ì„ ê³§ë°”ë¡œ ê°€ì ¸ì™€ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.</p>
<h2 id="í•„ìš”í•œ-íŒ¨í‚¤ì§€-ê°€ì ¸ì˜¤ê¸°"><a href="#í•„ìš”í•œ-íŒ¨í‚¤ì§€-ê°€ì ¸ì˜¤ê¸°" class="headerlink" title="í•„ìš”í•œ íŒ¨í‚¤ì§€ ê°€ì ¸ì˜¤ê¸°"></a>í•„ìš”í•œ íŒ¨í‚¤ì§€ ê°€ì ¸ì˜¤ê¸°</h2><p>tensorflow, sentencepieceë“±ì„ ê°€ì ¸ì˜¤ê³  bert ë ˆí¬ì—ì„œ ëª¨ë¸ ë“±ì„ ê°€ì ¸ì˜¨ë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> nltk</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> sentencepiece <span class="keyword">as</span> spm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> glob <span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">from</span> google.colab <span class="keyword">import</span> auth, drive</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras.utils <span class="keyword">import</span> Progbar</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">"bert"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bert <span class="keyword">import</span> modeling, optimization, tokenization</span><br><span class="line"><span class="keyword">from</span> bert.run_pretraining <span class="keyword">import</span> input_fn_builder, model_fn_builder</span><br><span class="line"></span><br><span class="line">auth.authenticate_user()</span><br></pre></td></tr></table></figure>

<p>ë§ˆì§€ë§‰ ì¤„(19ë²ˆì§¸ ì¤„)ì—ì„œëŠ” GCP ê³„ì •ìœ¼ë¡œ êµ¬ê¸€ì— ë¡œê·¸ì¸ í•œ ë’¤ ë‚˜ì˜¨ í† í° ê°’ì„ ì…ë ¥í•˜ë©´ êµ¬ê¸€ë“œë¼ì´ë¸Œì— ëŒ€í•œ ì ‘ê·¼ê³¼ GCS ë²„í‚·ì— ëŒ€í•œ ì ‘ê·¼ì„ í—ˆìš©í•´ì¤„ ìˆ˜ ìˆë‹¤.</p>
<p>ì´ ë¶€ë¶„ì€ ì´í›„ Tensorflowì—ì„œ TPUë¥¼ ì ‘ê·¼í•  ë•Œ GCSì— ìˆëŠ” ìì›ì—ë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ëª¨ë¸ íŒŒì¼ê³¼ ë°ì´í„°ì…‹ì„ GCS ë²„í‚·ì— ì—…ë¡œë“œí•  ë•Œ í•„ìš”í•˜ë‹¤.</p>
<p>ë§Œì•½ ì´ë¶€ë¶„ì´ ì§„í–‰ë˜ì§€ ì•Šìœ¼ë©´ TPUì—ì„œëŠ” <code>[local]</code> íŒŒì¼ ì‹œìŠ¤í…œì— ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤ëŠ” <code>NotImplementedError</code>ê°€ ë°œìƒí•œë‹¤.</p>
<blockquote>
<p>í•œí¸, PyTorch/XLAì—ì„œëŠ” TPU ë””ë°”ì´ìŠ¤ë¥¼ ë¡œì»¬ GPUì²˜ëŸ¼ ê°„í¸í•˜ê²Œ ì—°ê²°í•´ì„œ Tensor ê°ì²´ë¥¼ ììœ ë¡­ê²Œ ì£¼ê³ ë°›ë˜ë°, ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆëŠ”ì§€ ì˜ë¬¸ì´ë‹¤.</p>
</blockquote>
<h2 id="TPU-ìœ„ì¹˜-ì°¾ê¸°"><a href="#TPU-ìœ„ì¹˜-ì°¾ê¸°" class="headerlink" title="TPU ìœ„ì¹˜ ì°¾ê¸°"></a>TPU ìœ„ì¹˜ ì°¾ê¸°</h2><p>Colabì—ì„œ TPUë¥¼ í™œì„±í™”ì‹œí‚¤ë©´ <code>os.environ[&#39;COLAB_TPU_ADDR&#39;]</code> ì´ë¼ëŠ” ì‹œìŠ¤í…œ í™˜ê²½ë³€ìˆ˜ì— GRPCë¡œ í†µì‹ ê°€ëŠ¥í•œ ë¡œì»¬ IPë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.</p>
<p>ì•„ë˜ ì½”ë“œë¥¼ í†µí•´ í•™ìŠµ ê³¼ì •ì„ ë¡œê¹…í•˜ëŠ” ê²ƒê³¼ í•¨ê»˜ TPUì— ì—°ê²°í•˜ëŠ” ê²ƒì„ ì„¤ì •í•´ì¤„ ìˆ˜ ìˆë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configure logging</span></span><br><span class="line">log = logging.getLogger(<span class="string">'tensorflow'</span>)</span><br><span class="line">log.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="comment"># create formatter and add it to the handlers</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s :  %(message)s'</span>)</span><br><span class="line">sh = logging.StreamHandler()</span><br><span class="line">sh.setLevel(logging.INFO)</span><br><span class="line">sh.setFormatter(formatter)</span><br><span class="line">log.handlers = [sh]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">'COLAB_TPU_ADDR'</span> <span class="keyword">in</span> os.environ:</span><br><span class="line">  log.info(<span class="string">"Using TPU runtime"</span>)</span><br><span class="line">  USE_TPU = <span class="literal">True</span></span><br><span class="line">  TPU_ADDRESS = <span class="string">'grpc://'</span> + os.environ[<span class="string">'COLAB_TPU_ADDR'</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">with</span> tf.Session(TPU_ADDRESS) <span class="keyword">as</span> session:</span><br><span class="line">    log.info(<span class="string">'TPU address is '</span> + TPU_ADDRESS)</span><br><span class="line">    <span class="comment"># Upload credentials to TPU.</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/content/adc.json'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">      auth_info = json.load(f)</span><br><span class="line">    tf.contrib.cloud.configure_gcs(session, credentials=auth_info)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  log.warning(<span class="string">'Not connected to TPU runtime'</span>)</span><br><span class="line">  USE_TPU = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>ìœ„ì—ì„œ ì„¤ì •í•œ ê³¼ì •ì€ <code>/content/adc.json</code> íŒŒì¼ì— ì €ì¥ë˜ê³ , ì´ íŒŒì¼ ì„¤ì •ìœ¼ë¡œ TPUë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.</p>
<h2 id="ë°ì´í„°-ë‹¤ìš´ë°›ê¸°"><a href="#ë°ì´í„°-ë‹¤ìš´ë°›ê¸°" class="headerlink" title="ë°ì´í„° ë‹¤ìš´ë°›ê¸°"></a>ë°ì´í„° ë‹¤ìš´ë°›ê¸°</h2><p>í•™ìŠµí•˜ëŠ” ë°ì´í„°ë¥¼ ëª¨ìœ¼ëŠ” ê²ƒì€ ì‚¬ì‹¤ í•™ìŠµê³¼ ë³„ê°œë¡œ êµ‰ì¥íˆ ì¤‘ìš”í•œ ë¶€ë¶„ì´ë‹¤.</p>
<p>ì´ë²ˆì—ëŠ” ê°„ë‹¨í•˜ê²Œ <a href="http://www.opensubtitles.org/">OpenSubtitles</a> ë°ì´í„°ì…‹ì„ ì´ìš©í•´ í•œê¸€ ë°ì´í„°ë¥¼ ë‹¤ìš´ë°›ì•„ë³´ì.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">AVAILABLE =  &#123;<span class="string">'af'</span>,<span class="string">'ar'</span>,<span class="string">'bg'</span>,<span class="string">'bn'</span>,<span class="string">'br'</span>,<span class="string">'bs'</span>,<span class="string">'ca'</span>,<span class="string">'cs'</span>,</span><br><span class="line">              <span class="string">'da'</span>,<span class="string">'de'</span>,<span class="string">'el'</span>,<span class="string">'en'</span>,<span class="string">'eo'</span>,<span class="string">'es'</span>,<span class="string">'et'</span>,<span class="string">'eu'</span>,</span><br><span class="line">              <span class="string">'fa'</span>,<span class="string">'fi'</span>,<span class="string">'fr'</span>,<span class="string">'gl'</span>,<span class="string">'he'</span>,<span class="string">'hi'</span>,<span class="string">'hr'</span>,<span class="string">'hu'</span>,</span><br><span class="line">              <span class="string">'hy'</span>,<span class="string">'id'</span>,<span class="string">'is'</span>,<span class="string">'it'</span>,<span class="string">'ja'</span>,<span class="string">'ka'</span>,<span class="string">'kk'</span>,<span class="string">'ko'</span>,</span><br><span class="line">              <span class="string">'lt'</span>,<span class="string">'lv'</span>,<span class="string">'mk'</span>,<span class="string">'ml'</span>,<span class="string">'ms'</span>,<span class="string">'nl'</span>,<span class="string">'no'</span>,<span class="string">'pl'</span>,</span><br><span class="line">              <span class="string">'pt'</span>,<span class="string">'pt_br'</span>,<span class="string">'ro'</span>,<span class="string">'ru'</span>,<span class="string">'si'</span>,<span class="string">'sk'</span>,<span class="string">'sl'</span>,<span class="string">'sq'</span>,</span><br><span class="line">              <span class="string">'sr'</span>,<span class="string">'sv'</span>,<span class="string">'ta'</span>,<span class="string">'te'</span>,<span class="string">'th'</span>,<span class="string">'tl'</span>,<span class="string">'tr'</span>,<span class="string">'uk'</span>,</span><br><span class="line">              <span class="string">'ur'</span>,<span class="string">'vi'</span>,<span class="string">'ze_en'</span>,<span class="string">'ze_zh'</span>,<span class="string">'zh'</span>,<span class="string">'zh_cn'</span>,</span><br><span class="line">              <span class="string">'zh_en'</span>,<span class="string">'zh_tw'</span>,<span class="string">'zh_zh'</span>&#125;</span><br><span class="line"></span><br><span class="line">LANG_CODE = <span class="string">"ko"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> LANG_CODE <span class="keyword">in</span> AVAILABLE, <span class="string">"Invalid language code selected"</span></span><br><span class="line"></span><br><span class="line">!wget http://opus.nlpl.eu/download.php?f=OpenSubtitles/v2016/mono/OpenSubtitles.raw.'$LANG_CODE'.gz -O dataset.txt.gz</span><br><span class="line">!gzip -d dataset.txt.gz</span><br><span class="line">!tail dataset.txt</span><br></pre></td></tr></table></figure>

<p>11ë²ˆì§¸ì¤„ì˜ â€œLANG_CODEâ€ë¥¼ ë³€ê²½í•´ì£¼ë©´ ì›í•˜ëŠ” ì–¸ì–´ì˜ ë°ì´í„°ì…‹ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.</p>
<blockquote>
<p> í•œê¸€ ë°ì´í„°ì…‹ì˜ ê²½ìš° ì••ì¶•ëœ ìƒíƒœ ê¸°ì¤€ìœ¼ë¡œ ì•½ 8MBì˜ ë°ì´í„°ì…‹ì´ë‹¤.</p>
</blockquote>
<h2 id="ì˜µì…˜-ì¼ë¶€ë§Œ-ì‚¬ìš©í•´-í•™ìŠµí•˜ê¸°"><a href="#ì˜µì…˜-ì¼ë¶€ë§Œ-ì‚¬ìš©í•´-í•™ìŠµí•˜ê¸°" class="headerlink" title="(ì˜µì…˜) ì¼ë¶€ë§Œ ì‚¬ìš©í•´ í•™ìŠµí•˜ê¸°"></a>(ì˜µì…˜) ì¼ë¶€ë§Œ ì‚¬ìš©í•´ í•™ìŠµí•˜ê¸°</h2><p>ë°ì´í„°ì…‹ ì „ì²´ë¥¼ ì‚¬ìš©í•´ í•™ìŠµí•˜ë©´ í•™ìŠµì‹œê°„ì´ êµ‰ì¥íˆ ì˜¤ë˜ ê±¸ë¦°ë‹¤.</p>
<p>ë§Œì•½ ì‹¤ì œ ëª¨ë¸ì„ ì–»ê³ ì‹¶ì€ ê²ƒì´ ì•„ë‹ˆë¼ ë‹¨ìˆœíˆ í•™ìŠµ ê°€ëŠ¥í•œì§€ë§Œ ì•Œê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì²« ì¤„ì—ì„œ <code>DEMO_MODE=True</code> ë¡œ ì„¤ì •í•´ì£¼ë©´ ìˆ˜ëŸ‰ì„ 100ë§Œê°œ ë°ì´í„°ë¡œë§Œ í•™ìŠµí•œë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DEMO_MODE = <span class="literal">True</span> <span class="comment">#@param &#123;type:"boolean"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEMO_MODE:</span><br><span class="line">  CORPUS_SIZE = <span class="number">1000000</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  CORPUS_SIZE = <span class="number">100000000</span> <span class="comment">#@param &#123;type: "integer"&#125;</span></span><br><span class="line">  </span><br><span class="line">!(head -n $CORPUS_SIZE dataset.txt) &gt; subdataset.txt</span><br><span class="line">!mv subdataset.txt dataset.txt</span><br></pre></td></tr></table></figure>

<h2 id="í…ìŠ¤íŠ¸-ë°ì´í„°-ì „ì²˜ë¦¬í•˜ê¸°"><a href="#í…ìŠ¤íŠ¸-ë°ì´í„°-ì „ì²˜ë¦¬í•˜ê¸°" class="headerlink" title="í…ìŠ¤íŠ¸ ë°ì´í„° ì „ì²˜ë¦¬í•˜ê¸°"></a>í…ìŠ¤íŠ¸ ë°ì´í„° ì „ì²˜ë¦¬í•˜ê¸°</h2><p>í…ìŠ¤íŠ¸ ë°ì´í„°ì—ì„œ ë§ì´ ì“°ëŠ” ë¬¸ì¥ë¶€í˜¸ë‚˜ ê¸°íƒ€ ì´ëª¨í‹°ì½˜ğŸ¤©ë“±ì„ í•™ìŠµì—ì„œ <strong>ì œê±°í• ì§€, ì œê±°í•˜ì§€ ì•Šì„ì§€</strong>ëŠ” ìš°ë¦¬ê°€ í•™ìŠµì‹œí‚¤ëŠ” ëª¨ë¸ì´ <strong>ì–´ë–¤ ëª©ì </strong>ì´ëƒì— ë”°ë¼ ë‹¬ë¼ì§„ë‹¤.</p>
<p>ìœ„ì™€ ê°™ì€ ì´ëª¨í‹°ì½˜ì€ ì‚¬ìš© ë¹ˆë„ê°€ ë‚®ì€ í¸ì´ê¸° ë•Œë¬¸ì— ìœ„ ì´ëª¨í‹°ì½˜ì„ ì„ë² ë”©ì— í¬í•¨ì‹œí‚¬ ê²½ìš° Vocabì˜ ìš©ëŸ‰ì´ êµ‰ì¥íˆ ì»¤ì§€ê²Œ ë˜ì–´ ë³´í¸ì ì¸ Language Modelì„ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ë³´í†µ íŠ¹ìˆ˜ë¬¸ìë‚˜ ì´ëª¨í‹°ì½˜ ë“±ì„ ì œê±°í•´ì¤€ë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">regex_tokenizer = nltk.RegexpTokenizer(<span class="string">"\w+"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize_text</span><span class="params">(text)</span>:</span></span><br><span class="line">  <span class="comment"># lowercase text</span></span><br><span class="line">  text = str(text).lower()</span><br><span class="line">  <span class="comment"># remove non-UTF</span></span><br><span class="line">  text = text.encode(<span class="string">"utf-8"</span>, <span class="string">"ignore"</span>).decode()</span><br><span class="line">  <span class="comment"># remove punktuation symbols</span></span><br><span class="line">  text = <span class="string">" "</span>.join(regex_tokenizer.tokenize(text))</span><br><span class="line">  <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count_lines</span><span class="params">(filename)</span>:</span></span><br><span class="line">  count = <span class="number">0</span></span><br><span class="line">  <span class="keyword">with</span> open(filename) <span class="keyword">as</span> fi:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> fi:</span><br><span class="line">      count += <span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> count</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RAW_DATA_FPATH = <span class="string">"dataset.txt"</span> <span class="comment">#@param &#123;type: "string"&#125;</span></span><br><span class="line">PRC_DATA_FPATH = <span class="string">"proc_dataset.txt"</span> <span class="comment">#@param &#123;type: "string"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apply normalization to the dataset</span></span><br><span class="line"><span class="comment"># this will take a minute or two</span></span><br><span class="line"></span><br><span class="line">total_lines = count_lines(RAW_DATA_FPATH)</span><br><span class="line">bar = Progbar(total_lines)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(RAW_DATA_FPATH,encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fi:</span><br><span class="line">  <span class="keyword">with</span> open(PRC_DATA_FPATH, <span class="string">"w"</span>,encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fo:</span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> fi:</span><br><span class="line">      fo.write(normalize_text(l)+<span class="string">"\n"</span>)</span><br><span class="line">      bar.add(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ë°ì´í„°ì…‹-í…ìŠ¤íŠ¸-í† í¬ë‚˜ì´ì§•í•˜ê¸°"><a href="#ë°ì´í„°ì…‹-í…ìŠ¤íŠ¸-í† í¬ë‚˜ì´ì§•í•˜ê¸°" class="headerlink" title="ë°ì´í„°ì…‹ í…ìŠ¤íŠ¸ í† í¬ë‚˜ì´ì§•í•˜ê¸°"></a>ë°ì´í„°ì…‹ í…ìŠ¤íŠ¸ í† í¬ë‚˜ì´ì§•í•˜ê¸°</h2><p>BERTë“± NLP ëª¨ë¸ì„ í•™ìŠµì‹œí‚¬ë•ŒëŠ” í† í¬ë‚˜ì´ì§•í•œ Vocabì˜ í¬ê¸°ë¥¼ ì ì ˆíˆ ì œí•œí•˜ëŠ” ê²ƒì´ ëª¨ë¸ì˜ ì„±ëŠ¥ì„ ë†’ì´ëŠ”ë° ë„ì›€ì´ ëœë‹¤. (ìš©ëŸ‰ë„ ì—­ì‹œ)</p>
<p>í° ëª¨ë¸ì¼ìˆ˜ë¡ Vocabì˜ í¬ê¸°ë„ ì»¤ì§€ì§€ë§Œ, ë³´í†µì˜ ê²½ìš°ëŠ” 3ë§Œê°œ ë‚´ì™¸ì˜ Vocabì„ ë§Œë“œëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MODEL_PREFIX = <span class="string">"tokenizer"</span> <span class="comment">#@param &#123;type: "string"&#125;</span></span><br><span class="line">VOC_SIZE = <span class="number">32000</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">SUBSAMPLE_SIZE = <span class="number">12800000</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">NUM_PLACEHOLDERS = <span class="number">256</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line"></span><br><span class="line">SPM_COMMAND = (<span class="string">'--input=&#123;&#125; --model_prefix=&#123;&#125; '</span></span><br><span class="line">               <span class="string">'--vocab_size=&#123;&#125; --input_sentence_size=&#123;&#125; '</span></span><br><span class="line">               <span class="string">'--shuffle_input_sentence=true '</span> </span><br><span class="line">               <span class="string">'--bos_id=-1 --eos_id=-1'</span>).format(</span><br><span class="line">               PRC_DATA_FPATH, MODEL_PREFIX, </span><br><span class="line">               VOC_SIZE - NUM_PLACEHOLDERS, SUBSAMPLE_SIZE)</span><br><span class="line"></span><br><span class="line">spm.SentencePieceTrainer.Train(SPM_COMMAND)</span><br></pre></td></tr></table></figure>

<p>ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ SentencePieceì—ì„œ í•´ë‹¹ ëª¨ë¸ì„ ì—´ì‹¬íˆ ì˜ë¼ê°€ë©° Vocabì„ ìƒì„±í•˜ê³ , ì´í›„ í…ìŠ¤íŠ¸ë¥¼ ìë¥´ê¸° ìœ„í•œ Tokenizerë¥¼ í•™ìŠµí•œë‹¤.</p>
<p>í•™ìŠµëœ Sentencepiece Vocabì„ ë¡œë”©í•´ì£¼ì.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_sentencepiece_vocab</span><span class="params">(filepath)</span>:</span></span><br><span class="line">  voc = []</span><br><span class="line">  <span class="keyword">with</span> open(filepath, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> fi:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> fi:</span><br><span class="line">      voc.append(line.split(<span class="string">"\t"</span>)[<span class="number">0</span>])</span><br><span class="line">  <span class="comment"># skip the first &lt;unk&gt; token</span></span><br><span class="line">  voc = voc[<span class="number">1</span>:]</span><br><span class="line">  <span class="keyword">return</span> voc</span><br><span class="line"></span><br><span class="line">snt_vocab = read_sentencepiece_vocab(<span class="string">"&#123;&#125;.vocab"</span>.format(MODEL_PREFIX))</span><br><span class="line">print(<span class="string">"Learnt vocab size: &#123;&#125;"</span>.format(len(snt_vocab)))</span><br><span class="line">print(<span class="string">"Sample tokens: &#123;&#125;"</span>.format(random.sample(snt_vocab, <span class="number">10</span>)))</span><br></pre></td></tr></table></figure>

<p>ìœ„ SentencePieceë¥¼ í†µí•´ í•™ìŠµí•œ Vocabì„ BERTê°€ ì´í•´í•˜ëŠ” í˜•íƒœë¡œ ë°”ê¿”ì£¼ê¸° ìœ„í•´ì„œëŠ” <code>_</code>ë¡œ ì‹œì‘í•œ í† í°ë“¤ì„ <code>##</code> ìœ¼ë¡œ ì‹œì‘í•˜ë„ë¡ ë°”ê¿”ì£¼ë©´ ë˜ê³ , <code>[&quot;[PAD]&quot;,&quot;[UNK]&quot;,&quot;[CLS]&quot;,&quot;[SEP]&quot;,&quot;[MASK]&quot;]</code>ì˜ ê²½ìš°ëŠ” BERTì—ì„œ ì‚¬ìš©í•˜ëŠ” íŠ¹ìˆ˜ í† í°ì´ê¸° ë•Œë¬¸ì— í•´ë‹¹ í† í°ì— ëŒ€í•œ ì •ë³´ë“¤ì„ ì¶”ê°€í•´ ìµœì¢…ì ì¸ <code>bert_vocab</code>ì„ ë§Œë“¤ì–´ì¤€ë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_sentencepiece_token</span><span class="params">(token)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> token.startswith(<span class="string">"â–"</span>):</span><br><span class="line">        <span class="keyword">return</span> token[<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"##"</span> + token</span><br><span class="line"></span><br><span class="line">bert_vocab = list(map(parse_sentencepiece_token, snt_vocab))</span><br><span class="line">ctrl_symbols = [<span class="string">"[PAD]"</span>,<span class="string">"[UNK]"</span>,<span class="string">"[CLS]"</span>,<span class="string">"[SEP]"</span>,<span class="string">"[MASK]"</span>]</span><br><span class="line">bert_vocab = ctrl_symbols + bert_vocab</span><br></pre></td></tr></table></figure>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ì•ì„œì„œ ì‚¬ìš©í•˜ì§€ ì•Šì€ vocab rangeì— ìˆëŠ” ê²ƒë“¤ì„ ë„£ì–´ <code>bert_vocab</code>ì˜ í¬ê¸°ë¥¼ ì•ì„œ ì§€ì •í•œ <code>VOC_SIZE</code>ì— ë§ì¶°ì¤€ë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bert_vocab += [<span class="string">"[UNUSED_&#123;&#125;]"</span>.format(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(VOC_SIZE - len(bert_vocab))]</span><br><span class="line">print(len(bert_vocab))</span><br></pre></td></tr></table></figure>

<p>ì´ ê³¼ì •ì´ ë§ˆë¬´ë¦¬ë˜ë©´ <code>vocab.txt</code> í…ìŠ¤íŠ¸ íŒŒì¼ì— ìœ„ í† í°ë“¤ì„ ëª¨ë‘ í•œì¤„ í•œì¤„ ì €ì¥í•´ì£¼ë©´ ì´í›„ì— ì‚¬ìš©í•  ê²ƒë“¤ì´ ëë‚˜ê²Œ ëœë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VOC_FNAME = <span class="string">"vocab.txt"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(VOC_FNAME, <span class="string">"w"</span>) <span class="keyword">as</span> fo:</span><br><span class="line">  <span class="keyword">for</span> token <span class="keyword">in</span> bert_vocab:</span><br><span class="line">    fo.write(token+<span class="string">"\n"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="í•™ìŠµ-ë°ì´í„°-ìª¼ê°œê¸°"><a href="#í•™ìŠµ-ë°ì´í„°-ìª¼ê°œê¸°" class="headerlink" title="í•™ìŠµ ë°ì´í„° ìª¼ê°œê¸°"></a>í•™ìŠµ ë°ì´í„° ìª¼ê°œê¸°</h2><p>í•™ìŠµ ë°ì´í„°ì˜ í¬ê¸°ê°€ êµ‰ì¥íˆ í´ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— í•™ìŠµ ì›ì²œ ë°ì´í„°ë¥¼ ì ë‹¹í•œ ì‚¬ì´ì¦ˆë¡œ ì˜ë¼ì¤€ë‹¤.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!mkdir ./shards</span><br><span class="line">!split -a 4 -l 256000 -d <span class="variable">$PRC_DATA_FPATH</span> ./shards/shard_</span><br><span class="line">!ls ./shards/</span><br></pre></td></tr></table></figure>

<h2 id="BERT-Pretrainingì„-ìœ„í•œ-ë°ì´í„°-ë³€ìˆ˜-ì„¤ì •í•˜ê¸°"><a href="#BERT-Pretrainingì„-ìœ„í•œ-ë°ì´í„°-ë³€ìˆ˜-ì„¤ì •í•˜ê¸°" class="headerlink" title="BERT Pretrainingì„ ìœ„í•œ ë°ì´í„° ë³€ìˆ˜ ì„¤ì •í•˜ê¸°"></a>BERT Pretrainingì„ ìœ„í•œ ë°ì´í„° ë³€ìˆ˜ ì„¤ì •í•˜ê¸°</h2><p>BERTë¥¼ ìœ„í•œ ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ëŠ” ê³¼ì •ì— ìˆì–´ì„œ ëª‡ê°€ì§€ ì„¤ì •í•´ì¤˜ì•¼ í•˜ëŠ” ê²ƒë“¤ì´ ìˆë‹¤.</p>
<ul>
<li>MAX_SEQ_LENGTH: BERTì˜ ëª¨ë¸ ì…ë ¥ì˜ ìµœì¥ í† í° ê¸¸ì´<ul>
<li>ì´ ì´ìƒìœ¼ë¡œëŠ” BERTëª¨ë¸ì´ ì´í•´í•˜ì§€ ëª»í•œë‹¤.</li>
</ul>
</li>
<li>MASKED_LM_PROB: BERTì˜ í•™ìŠµ ì¤‘ Masked LMì˜ ë¹„ìœ¨ì„ ì¡°ì •í•œë‹¤.</li>
<li>MAX_PREDICTIONS: Sequenceë³„ ì˜ˆì¸¡í•  ìµœëŒ€ ê¸¸ì´</li>
<li>DO_LOWER_CASE: ì˜ë¬¸ìë¥¼ lower(ì†Œë¬¸ìí™”) í•  ì§€. í•œê¸€ì—ëŠ” ì˜ë¯¸ì—†ë‹¤.</li>
<li>PROCESSES: ì „ì²˜ë¦¬í• ë•Œ CPU ëª‡ê°œ ì“¸ì§€</li>
<li>PRETRAINING_DIR: í”„ë¦¬íŠ¸ë ˆì¸ ë°ì´í„° í´ë” ì´ë¦„</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MAX_SEQ_LENGTH = <span class="number">128</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">MASKED_LM_PROB = <span class="number">0.15</span> <span class="comment">#@param</span></span><br><span class="line">MAX_PREDICTIONS = <span class="number">20</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">DO_LOWER_CASE = <span class="literal">True</span> <span class="comment">#@param &#123;type:"boolean"&#125;</span></span><br><span class="line">PROCESSES = <span class="number">4</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">PRETRAINING_DIR = <span class="string">"pretraining_data"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br></pre></td></tr></table></figure>

<p>ìœ„ã… ê°™ì´ ì„¤ì •ì„ ì§„í–‰í•œ ë’¤, ì•„ë˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ Pretraining Dataê°€ ë§Œë“¤ì–´ì§„ë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">XARGS_CMD = (<span class="string">"ls ./shards/ | "</span></span><br><span class="line">             <span class="string">"xargs -n 1 -P &#123;&#125; -I&#123;&#125; "</span></span><br><span class="line">             <span class="string">"python3 bert/create_pretraining_data.py "</span></span><br><span class="line">             <span class="string">"--input_file=./shards/&#123;&#125; "</span></span><br><span class="line">             <span class="string">"--output_file=&#123;&#125;/&#123;&#125;.tfrecord "</span></span><br><span class="line">             <span class="string">"--vocab_file=&#123;&#125; "</span></span><br><span class="line">             <span class="string">"--do_lower_case=&#123;&#125; "</span></span><br><span class="line">             <span class="string">"--max_predictions_per_seq=&#123;&#125; "</span></span><br><span class="line">             <span class="string">"--max_seq_length=&#123;&#125; "</span></span><br><span class="line">             <span class="string">"--masked_lm_prob=&#123;&#125; "</span></span><br><span class="line">             <span class="string">"--random_seed=34 "</span></span><br><span class="line">             <span class="string">"--dupe_factor=5"</span>)</span><br><span class="line"></span><br><span class="line">XARGS_CMD = XARGS_CMD.format(PROCESSES, <span class="string">'&#123;&#125;'</span>, <span class="string">'&#123;&#125;'</span>, PRETRAINING_DIR, <span class="string">'&#123;&#125;'</span>, </span><br><span class="line">                             VOC_FNAME, DO_LOWER_CASE, </span><br><span class="line">                             MAX_PREDICTIONS, MAX_SEQ_LENGTH, MASKED_LM_PROB)</span><br><span class="line"></span><br><span class="line">tf.gfile.MkDir(PRETRAINING_DIR)</span><br><span class="line">!$XARGS_CMD</span><br></pre></td></tr></table></figure>

<h2 id="GCP-ë²„í‚·ì—-ëª¨ë¸-amp-í•™ìŠµ-ë°ì´í„°-ì˜¬ë¦¬ê¸°"><a href="#GCP-ë²„í‚·ì—-ëª¨ë¸-amp-í•™ìŠµ-ë°ì´í„°-ì˜¬ë¦¬ê¸°" class="headerlink" title="GCP ë²„í‚·ì— ëª¨ë¸ &amp; í•™ìŠµ ë°ì´í„° ì˜¬ë¦¬ê¸°"></a>GCP ë²„í‚·ì— ëª¨ë¸ &amp; í•™ìŠµ ë°ì´í„° ì˜¬ë¦¬ê¸°</h2><p>Tensorflowë¥¼ í†µí•´ TPUë¡œ í•™ìŠµì„ ì§„í–‰í•˜ë ¤ë©´ ì•ì„œ ì–¸ê¸‰í•œ ê²ƒê³¼ ê°™ì´ GCSì— ë°ì´í„°ì™€ ëª¨ë¸ì„ ì—…ë¡œë“œí•´ì•¼ í•œë‹¤.</p>
<p>ì²«ì§¸ ì¤„ì˜ <code>BUCKET_NAME</code>ì„ ê°œê°œì¸ì˜ GCS ë²„í‚·ì´ë¦„ìœ¼ë¡œ ìˆ˜ì •í•˜ë©´ ëœë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BUCKET_NAME = <span class="string">"ì´ë¶€ë¶„ì„_ìˆ˜ì •í•´_ì£¼ì„¸ìš”"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line">MODEL_DIR = <span class="string">"bert_model"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line">tf.gfile.MkDir(MODEL_DIR)</span><br></pre></td></tr></table></figure>

<h2 id="BERT-Model-Hyper-Parameters-ì„¤ì •í•˜ê¸°"><a href="#BERT-Model-Hyper-Parameters-ì„¤ì •í•˜ê¸°" class="headerlink" title="BERT Model Hyper Parameters ì„¤ì •í•˜ê¸°"></a>BERT Model Hyper Parameters ì„¤ì •í•˜ê¸°</h2><p>BERT ëª¨ë¸ì„ ì–´ë–¤ êµ¬ì¡°ì˜ ëª¨ë¸ì„ ì‚¬ìš©í• ì§€ì— ëŒ€í•œ Hyper Parametersë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤.</p>
<p>ì–¼ë§ˆë‚˜ Dropoutì„ í•´ì¤„ì§€, Bidirectionalí•˜ê²Œ í• ì§€, Activation Functionì„ ë­˜ë¡œ í•´ì¤„ì§€, Hidden Sizeë¥¼ ì–¼ë§ˆë‚˜ í•´ì¤„ì§€, Attention Headë¥¼ ëª‡ê°œë¡œ í•´ì¤„ì§€, ë ˆì´ì–´ë¥¼ ëª‡ ì¸µìœ¼ë¡œ ìŒ“ì„ ì§€ ë“±ë“±â€¦</p>
<p>ì•„ë˜ ì„¤ì •ì€ BERT Base ëª¨ë¸ì˜ ê¸°ë³¸ê°’ì´ë‹¤. ì•„ë˜ ê°’ì„ ìˆ˜ì •í•˜ë©´ ì¢€ ë” ë‹¤ë¥´ê²Œ í•™ìŠµëœ BERT ëª¨ë¸ì„ ë§Œë“¤ ìˆ˜ ìˆê²Œ ëœë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">bert_base_config = &#123;</span><br><span class="line">  <span class="string">"attention_probs_dropout_prob"</span>: <span class="number">0.1</span>, </span><br><span class="line">  <span class="string">"directionality"</span>: <span class="string">"bidi"</span>, </span><br><span class="line">  <span class="string">"hidden_act"</span>: <span class="string">"gelu"</span>, </span><br><span class="line">  <span class="string">"hidden_dropout_prob"</span>: <span class="number">0.1</span>, </span><br><span class="line">  <span class="string">"hidden_size"</span>: <span class="number">768</span>, </span><br><span class="line">  <span class="string">"initializer_range"</span>: <span class="number">0.02</span>, </span><br><span class="line">  <span class="string">"intermediate_size"</span>: <span class="number">3072</span>, </span><br><span class="line">  <span class="string">"max_position_embeddings"</span>: <span class="number">512</span>, </span><br><span class="line">  <span class="string">"num_attention_heads"</span>: <span class="number">12</span>, </span><br><span class="line">  <span class="string">"num_hidden_layers"</span>: <span class="number">12</span>, </span><br><span class="line">  <span class="string">"pooler_fc_size"</span>: <span class="number">768</span>, </span><br><span class="line">  <span class="string">"pooler_num_attention_heads"</span>: <span class="number">12</span>, </span><br><span class="line">  <span class="string">"pooler_num_fc_layers"</span>: <span class="number">3</span>, </span><br><span class="line">  <span class="string">"pooler_size_per_head"</span>: <span class="number">128</span>, </span><br><span class="line">  <span class="string">"pooler_type"</span>: <span class="string">"first_token_transform"</span>, </span><br><span class="line">  <span class="string">"type_vocab_size"</span>: <span class="number">2</span>, </span><br><span class="line">  <span class="string">"vocab_size"</span>: VOC_SIZE</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"&#123;&#125;/bert_config.json"</span>.format(MODEL_DIR), <span class="string">"w"</span>) <span class="keyword">as</span> fo:</span><br><span class="line">  json.dump(bert_base_config, fo, indent=<span class="number">2</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"&#123;&#125;/&#123;&#125;"</span>.format(MODEL_DIR, VOC_FNAME), <span class="string">"w"</span>) <span class="keyword">as</span> fo:</span><br><span class="line">  <span class="keyword">for</span> token <span class="keyword">in</span> bert_vocab:</span><br><span class="line">    fo.write(token+<span class="string">"\n"</span>)</span><br></pre></td></tr></table></figure>

<p>ê·¸ë¦¬ê³  ì•ì„œ ë§Œë“¤ì–´ì¤€ ëª¨ë¸, í”„ë¦¬íŠ¸ë ˆì´ë‹ ë°ì´í„°ë¥¼ GCS ë²„í‚·ì— ì—…ë¡œë“œí•œë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> BUCKET_NAME:</span><br><span class="line">  !gsutil -m cp -r $MODEL_DIR $PRETRAINING_DIR gs://$BUCKET_NAME</span><br></pre></td></tr></table></figure>

<h2 id="ëª¨ë¸-í•™ìŠµ-Hyper-Parameters-ì„¤ì •í•˜ê¸°"><a href="#ëª¨ë¸-í•™ìŠµ-Hyper-Parameters-ì„¤ì •í•˜ê¸°" class="headerlink" title="ëª¨ë¸ í•™ìŠµ Hyper Parameters ì„¤ì •í•˜ê¸°"></a>ëª¨ë¸ í•™ìŠµ Hyper Parameters ì„¤ì •í•˜ê¸°</h2><p>GCS ë²„í‚·ì— ë°ì´í„°ì™€ ëª¨ë¸ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ì¤€ ë’¤, ì‹¤ì œ TPUì—ì„œ í•™ìŠµì„ ì§„í–‰í•˜ë„ë¡ ëª…ë ¹ì„ ë„˜ê²¨ì¤˜ì•¼ í•œë‹¤.</p>
<p>ì²«ë²ˆì§¸ ì¤„ì˜ <code>BUCKET_NAME</code>ë§Œ ìœ„ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •í•´ì£¼ë©´ ëœë‹¤.</p>
<p>ì¤‘ê°„ì˜ <code>BATCH_SIZE</code>, <code>LEARNING_RATE</code>, <code>TRAIN_STEPS</code>, <code>NUM_TPU_CORES</code> ë“±ì˜ ë³€ìˆ˜ë¥¼ ì¡°ì ˆí•´ ëª¨ë¸ì˜ í•™ìŠµ ì†ë„ë¥¼ ê²°ì •í•  ìˆ˜ ìˆë‹¤.</p>
<blockquote>
<p>Colabì˜ TPUëŠ” <code>v3-8</code>ì´ë¯€ë¡œ <code>NUM_TPU_CORES</code>ëŠ” 8Coreê°€ ìµœëŒ€ë‹¤.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">BUCKET_NAME = <span class="string">"beomi-blog-sample"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line">MODEL_DIR = <span class="string">"bert_model"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line">PRETRAINING_DIR = <span class="string">"pretraining_data"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line">VOC_FNAME = <span class="string">"vocab.txt"</span> <span class="comment">#@param &#123;type:"string"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Input data pipeline config</span></span><br><span class="line">TRAIN_BATCH_SIZE = <span class="number">128</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">MAX_PREDICTIONS = <span class="number">20</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">MAX_SEQ_LENGTH = <span class="number">128</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">MASKED_LM_PROB = <span class="number">0.15</span> <span class="comment">#@param</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Training procedure config</span></span><br><span class="line">EVAL_BATCH_SIZE = <span class="number">64</span></span><br><span class="line">LEARNING_RATE = <span class="number">2e-5</span></span><br><span class="line">TRAIN_STEPS = <span class="number">1000000</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">SAVE_CHECKPOINTS_STEPS = <span class="number">2500</span> <span class="comment">#@param &#123;type:"integer"&#125;</span></span><br><span class="line">NUM_TPU_CORES = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> BUCKET_NAME:</span><br><span class="line">  BUCKET_PATH = <span class="string">"gs://&#123;&#125;"</span>.format(BUCKET_NAME)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  BUCKET_PATH = <span class="string">"."</span></span><br><span class="line"></span><br><span class="line">BERT_GCS_DIR = <span class="string">"&#123;&#125;/&#123;&#125;"</span>.format(BUCKET_PATH, MODEL_DIR)</span><br><span class="line">DATA_GCS_DIR = <span class="string">"&#123;&#125;/&#123;&#125;"</span>.format(BUCKET_PATH, PRETRAINING_DIR)</span><br><span class="line"></span><br><span class="line">VOCAB_FILE = os.path.join(BERT_GCS_DIR, VOC_FNAME)</span><br><span class="line">CONFIG_FILE = os.path.join(BERT_GCS_DIR, <span class="string">"bert_config.json"</span>)</span><br><span class="line"></span><br><span class="line">INIT_CHECKPOINT = tf.train.latest_checkpoint(BERT_GCS_DIR)</span><br><span class="line"></span><br><span class="line">bert_config = modeling.BertConfig.from_json_file(CONFIG_FILE)</span><br><span class="line">input_files = tf.gfile.Glob(os.path.join(DATA_GCS_DIR,<span class="string">'*tfrecord'</span>))</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">"Using checkpoint: &#123;&#125;"</span>.format(INIT_CHECKPOINT))</span><br><span class="line">log.info(<span class="string">"Using &#123;&#125; data shards"</span>.format(len(input_files)))</span><br></pre></td></tr></table></figure>

<h2 id="ëª¨ë¸ì„-TPUë¡œ-ì˜¬ë¦¬ê³ -í•™ìŠµí•˜ê¸°"><a href="#ëª¨ë¸ì„-TPUë¡œ-ì˜¬ë¦¬ê³ -í•™ìŠµí•˜ê¸°" class="headerlink" title="ëª¨ë¸ì„ TPUë¡œ ì˜¬ë¦¬ê³  í•™ìŠµí•˜ê¸°"></a>ëª¨ë¸ì„ TPUë¡œ ì˜¬ë¦¬ê³  í•™ìŠµí•˜ê¸°</h2><p><code>model_fn</code> ì´ë¼ëŠ” ì´ë¦„ì˜ ë”¥ëŸ¬ë‹ ëª¨ë¸ ì„¤ì • ê°ì²´ë¥¼ ë§Œë“¤ì–´ì£¼ê³  TPUì— ì—°ê²°í•´ì¤€ ë’¤, ì–´ë–»ê²Œ í•™ìŠµì„ í•˜ê³  ì–´ë””ì— CheckPointë¥¼ ì •ë¦¬í• ì§€ ë“±ì„ ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤.</p>
<p>ì´í›„ TPUEstimatorë¥¼ í†µí•´ ëª¨ë¸ ê°ì²´, ì„¤ì • ê°ì²´ë¥¼ ì „ë‹¬í•´ì£¼ê³ , í•´ë‹¹ estimatorë¥¼ <code>estimator.train()</code> í•˜ë©´ TPU ìœ„ì—ì„œ BERT ëª¨ë¸ì˜ í•™ìŠµì´ ì§„í–‰ëœë‹¤.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">model_fn = model_fn_builder(</span><br><span class="line">      bert_config=bert_config,</span><br><span class="line">      init_checkpoint=INIT_CHECKPOINT,</span><br><span class="line">      learning_rate=LEARNING_RATE,</span><br><span class="line">      num_train_steps=TRAIN_STEPS,</span><br><span class="line">      num_warmup_steps=<span class="number">10</span>,</span><br><span class="line">      use_tpu=USE_TPU,</span><br><span class="line">      use_one_hot_embeddings=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">tpu_cluster_resolver = tf.contrib.cluster_resolver.TPUClusterResolver(TPU_ADDRESS)</span><br><span class="line"></span><br><span class="line">run_config = tf.contrib.tpu.RunConfig(</span><br><span class="line">    cluster=tpu_cluster_resolver,</span><br><span class="line">    model_dir=BERT_GCS_DIR,</span><br><span class="line">    save_checkpoints_steps=SAVE_CHECKPOINTS_STEPS,</span><br><span class="line">    tpu_config=tf.contrib.tpu.TPUConfig(</span><br><span class="line">        iterations_per_loop=SAVE_CHECKPOINTS_STEPS,</span><br><span class="line">        num_shards=NUM_TPU_CORES,</span><br><span class="line">        per_host_input_for_training=tf.contrib.tpu.InputPipelineConfig.PER_HOST_V2))</span><br><span class="line"></span><br><span class="line">estimator = tf.contrib.tpu.TPUEstimator(</span><br><span class="line">    use_tpu=USE_TPU,</span><br><span class="line">    model_fn=model_fn,</span><br><span class="line">    config=run_config,</span><br><span class="line">    train_batch_size=TRAIN_BATCH_SIZE,</span><br><span class="line">    eval_batch_size=EVAL_BATCH_SIZE)</span><br><span class="line">  </span><br><span class="line">train_input_fn = input_fn_builder(</span><br><span class="line">        input_files=input_files,</span><br><span class="line">        max_seq_length=MAX_SEQ_LENGTH,</span><br><span class="line">        max_predictions_per_seq=MAX_PREDICTIONS,</span><br><span class="line">        is_training=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># í•™ìŠµí•˜ì!!</span></span><br><span class="line">estimator.train(input_fn=train_input_fn, max_steps=TRAIN_STEPS)</span><br></pre></td></tr></table></figure>

<h2 id="ì–´ë””ì—-ëª¨ë¸ì´-ì €ì¥ë˜ë‚˜"><a href="#ì–´ë””ì—-ëª¨ë¸ì´-ì €ì¥ë˜ë‚˜" class="headerlink" title="ì–´ë””ì— ëª¨ë¸ì´ ì €ì¥ë˜ë‚˜?"></a>ì–´ë””ì— ëª¨ë¸ì´ ì €ì¥ë˜ë‚˜?</h2><p><code>estimator.train</code> ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ TPUìœ„ì—ì„œ í•™ìŠµì´ ì´ë¤„ì§€ê³ , ë™ì‹œì— ìš°ë¦¬ê°€ ì§€ì •í•œ ì²´í¬í¬ì¸íŠ¸(<code>SAVE_CHECKPOINTS_STEPS</code>)ë³„ë¡œ GCS ë²„í‚·ì˜ í´ë”ì— ëª¨ë¸ì˜ ê°€ì¤‘ì¹˜ê°’ì´ ì €ì¥ëœë‹¤.</p>
<p><img src="https://d1sr4ybm5bj1wl.cloudfront.net/img/2020-02-26-154241.png" alt="BERT ëª¨ë¸ì˜ CheckPointëŠ” GCSì— ì—…ë¡œë“œëœë‹¤."></p>
<p>Google Colabì€ Proë¥¼ ì“°ë”ë¼ë„ ìµœëŒ€ 24ì‹œê°„ì´ í•œê³„ì´ê³ , ê±°ëŒ€í•œ ë°ì´í„°ë¡œ í•™ìŠµì‹œí‚¬ë•ŒëŠ” ì„¸ì…˜ì´ ì¢…ë£Œë˜ê¸° ë•Œë¬¸ì— ì²´í¬í¬ì¸íŠ¸ë¥¼ ê°€ì ¸ì™€ í•´ë‹¹ ë¶€ë¶„ë¶€í„° í•™ìŠµì„ ì¬ê²Œí•˜ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.</p>
<p>ì´ì™€ ê°™ì´ GCS ë²„í‚·ì— ì €ì¥ì„ í•˜ëŠ” ê²ƒì„ í†µí•´ì„œ BERT ëª¨ë¸ì„ Colab TPUë¡œ ì²˜ìŒë¶€í„° ëê¹Œì§€ ìš°ë¦¬ ë°ì´í„°ë¥¼ í†µí•´ í•™ìŠµì‹œí‚¬ìˆ˜ ìˆë‹¤.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://arxiv.org/abs/1810.04805">BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding</a></li>
<li><a href="https://towardsdatascience.com/pre-training-bert-from-scratch-with-cloud-tpu-6e2f71028379">Pre-training BERT from scratch with cloud TPU</a></li>
</ul>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/bert/" rel="tag">bert</a>, <a class="has-link-grey -link" href="/tags/colab/" rel="tag">colab</a>, <a class="has-link-grey -link" href="/tags/nlp/" rel="tag">nlp</a>, <a class="has-link-grey -link" href="/tags/tensorflow/" rel="tag">tensorflow</a>, <a class="has-link-grey -link" href="/tags/tpu/" rel="tag">tpu</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/05/29/Gitlab-for-LFS/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">ë”¥ëŸ¬ë‹ í”„ë¡œì íŠ¸ 100% ì¬í˜„ì„ ìœ„í•œ Git-LFSì™€ Gitlab</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2020/02/24/Pytorch-with-TPU-on-Colab/">
                <span class="level-item">Colabì—ì„œ PyTorch ëª¨ë¸ TPUë¡œ í•™ìŠµí•˜ê¸°</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                
                




<div class="column is-4-tablet is-4-desktop is-4-widescreen  has-order-3 column-right ">
    
        

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    ì¹´íƒˆë¡œê·¸
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#ì–´ë–¤-í™˜ê²½ì—ì„œ-ê°œë°œí•˜ë‚˜">
        <span class="has-mr-6">1</span>
        <span>ì–´ë–¤ í™˜ê²½ì—ì„œ ê°œë°œí•˜ë‚˜?</span>
        </a></li><li>
        <a class="is-flex" href="#ì¤€ë¹„ë¬¼">
        <span class="has-mr-6">2</span>
        <span>ì¤€ë¹„ë¬¼</span>
        </a></li><li>
        <a class="is-flex" href="#í•„ìš”í•œ-ë¼ì´ë¸ŒëŸ¬ë¦¬-ì„¤ì¹˜í•˜ê¸°">
        <span class="has-mr-6">3</span>
        <span>í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜í•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#í•„ìš”í•œ-íŒ¨í‚¤ì§€-ê°€ì ¸ì˜¤ê¸°">
        <span class="has-mr-6">4</span>
        <span>í•„ìš”í•œ íŒ¨í‚¤ì§€ ê°€ì ¸ì˜¤ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#TPU-ìœ„ì¹˜-ì°¾ê¸°">
        <span class="has-mr-6">5</span>
        <span>TPU ìœ„ì¹˜ ì°¾ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#ë°ì´í„°-ë‹¤ìš´ë°›ê¸°">
        <span class="has-mr-6">6</span>
        <span>ë°ì´í„° ë‹¤ìš´ë°›ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#ì˜µì…˜-ì¼ë¶€ë§Œ-ì‚¬ìš©í•´-í•™ìŠµí•˜ê¸°">
        <span class="has-mr-6">7</span>
        <span>(ì˜µì…˜) ì¼ë¶€ë§Œ ì‚¬ìš©í•´ í•™ìŠµí•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#í…ìŠ¤íŠ¸-ë°ì´í„°-ì „ì²˜ë¦¬í•˜ê¸°">
        <span class="has-mr-6">8</span>
        <span>í…ìŠ¤íŠ¸ ë°ì´í„° ì „ì²˜ë¦¬í•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#ë°ì´í„°ì…‹-í…ìŠ¤íŠ¸-í† í¬ë‚˜ì´ì§•í•˜ê¸°">
        <span class="has-mr-6">9</span>
        <span>ë°ì´í„°ì…‹ í…ìŠ¤íŠ¸ í† í¬ë‚˜ì´ì§•í•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#í•™ìŠµ-ë°ì´í„°-ìª¼ê°œê¸°">
        <span class="has-mr-6">10</span>
        <span>í•™ìŠµ ë°ì´í„° ìª¼ê°œê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#BERT-Pretrainingì„-ìœ„í•œ-ë°ì´í„°-ë³€ìˆ˜-ì„¤ì •í•˜ê¸°">
        <span class="has-mr-6">11</span>
        <span>BERT Pretrainingì„ ìœ„í•œ ë°ì´í„° ë³€ìˆ˜ ì„¤ì •í•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#GCP-ë²„í‚·ì—-ëª¨ë¸-amp-í•™ìŠµ-ë°ì´í„°-ì˜¬ë¦¬ê¸°">
        <span class="has-mr-6">12</span>
        <span>GCP ë²„í‚·ì— ëª¨ë¸ & í•™ìŠµ ë°ì´í„° ì˜¬ë¦¬ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#BERT-Model-Hyper-Parameters-ì„¤ì •í•˜ê¸°">
        <span class="has-mr-6">13</span>
        <span>BERT Model Hyper Parameters ì„¤ì •í•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#ëª¨ë¸-í•™ìŠµ-Hyper-Parameters-ì„¤ì •í•˜ê¸°">
        <span class="has-mr-6">14</span>
        <span>ëª¨ë¸ í•™ìŠµ Hyper Parameters ì„¤ì •í•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#ëª¨ë¸ì„-TPUë¡œ-ì˜¬ë¦¬ê³ -í•™ìŠµí•˜ê¸°">
        <span class="has-mr-6">15</span>
        <span>ëª¨ë¸ì„ TPUë¡œ ì˜¬ë¦¬ê³  í•™ìŠµí•˜ê¸°</span>
        </a></li><li>
        <a class="is-flex" href="#ì–´ë””ì—-ëª¨ë¸ì´-ì €ì¥ë˜ë‚˜">
        <span class="has-mr-6">16</span>
        <span>ì–´ë””ì— ëª¨ë¸ì´ ì €ì¥ë˜ë‚˜?</span>
        </a></li><li>
        <a class="is-flex" href="#References">
        <span class="has-mr-6">17</span>
        <span>References</span>
        </a></li></ul>
            </div>
        </div>
    </div>

    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    Beomi&#39;s Tech Blog
                
                </a>
                <p class="is-size-7">
                &copy; 2021 Junbum Lee&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("ko");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://beomi.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Kembali ke atas" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>








<script src="/js/main.js" defer></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

    
</body>
</html>