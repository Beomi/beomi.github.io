<!DOCTYPE html>
<html  lang="ko">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.1" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Fabric으로 Django 배포하기 - Beomi&#39;s Tech blog</title>








<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-89162642-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-89162642-1');
</script>

    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    


<link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body class="is-1-column">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                Beomi&#39;s Tech Blog
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="https://junbuml.ee">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-12 has-order-2 column-main">
<div class="card">
    
    <div class="card-image">
        <span  class="image is-7by1">
            <img class="thumbnail" src="https://d1sr4ybm5bj1wl.cloudfront.net/img/old_post/python-fabric-logo.jpg" alt="Fabric으로 Django 배포하기">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-03-19T15:00:00.000Z">2017-03-20</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/python/">python</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/python/fabric/">fabric</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/python/fabric/django/">django</a>
                </div>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Fabric으로 Django 배포하기
            
        </h1>
        <div class="content">
            <blockquote>
<p>이번 가이드는 완성된 상태의 Django 프로젝트가 있다고 가정합니다. 예제로 <a href="https://github.com/Beomi/irkshop">https://github.com/Beomi/irkshop</a> 을 배포해 봅니다.</p>
</blockquote>
<blockquote>
<p><a href="https://gist.github.com/Beomi/945cd905175c3b21370f8f04abd57404">https://gist.github.com/Beomi/945cd905175c3b21370f8f04abd57404</a>의 예제를 설명합니다.</p>
</blockquote>
<h1 id="Fabric으로-Django-배포하기"><a href="#Fabric으로-Django-배포하기" class="headerlink" title="Fabric으로 Django 배포하기"></a>Fabric으로 Django 배포하기</h1><p>Django는 내장된 <code>runserver</code>라는 개발용 웹 서버가 있습니다. 하지만 개발용 웹 서버를 상용 환경에서 사용하는 것은 여러가지 문제를 가져옵니다. 메모리 문제등의 성능 이슈부터 Static file서빙의 보안 문제까지 다양한데요, 이 때문에 Django는 웹 서버(ex: <code>Apache2</code> <code>NginX</code>등)를 통해 배포하게 됩니다.</p>
<p>하지만 이러한 배포작업은 아마존 EC2등의 VPS나 리얼 서버에서 <code>Apache2</code>를 깔고, <code>python3</code>와 <code>mod_wsgi</code>등을 깔아야만 동작하기 때문에 배포 자체가 어려움을 갖게 됩니다. 또한 SSH에 접속히 직접 명령어를 치는 경우 오타나 실수등으로 인해 정상적으로 작동하지 않는 경우도 부지기수입니다.</p>
<p>따라서 이러한 작업을 자동화해주는 도구가 바로 Fabric이고, 이번 가이드에서는 Django 프로젝트를 Vultr VPS, Ubuntu에 올리는 방법을 다룹니다.</p>
<h2 id="Vultr-VPS-생성하기"><a href="#Vultr-VPS-생성하기" class="headerlink" title="Vultr VPS 생성하기"></a>Vultr VPS 생성하기</h2><p><a href="vultr.com">Vultr</a>는 VPS(가상서버) 제공 회사입니다. 최근 가격 인하로 유사 서비스 대비 절반 가격에 이용할 수 있어 가성비가 좋습니다.</p>
<p>사용자가 많지 않은 (혹은 혼자 사용하는..) 서비스라면 최소 가격인 1cpu 512MB의 월 2.5달러짜리를 이용하시면 됩니다.</p>
<p>Vultr는 일본 Region에 서버가 있어 한국에서 사용하기에도 핑이 25ms정도로 양호합니다.</p>
<p>VPS하나를 만든 후 root로 접속해 장고를 구동할 사용자를 만들어 봅시다.</p>
<p><img src="https://d1sr4ybm5bj1wl.cloudfront.net/img/dropbox/2017-03-19%2023.20.21.png" alt="예제VPS"></p>
<h2 id="django-유저-만들기-sudo권한-가진-유저-만들기"><a href="#django-유저-만들기-sudo권한-가진-유저-만들기" class="headerlink" title="django 유저 만들기(sudo권한 가진 유저 만들기)"></a><code>django</code> 유저 만들기(sudo권한 가진 유저 만들기)</h2><p>Fabric을 사용할 때 초기에 <code>apt</code>를 이용해 패키지를 설치해야 할 필요가 있습니다.</p>
<p>하지만 처음에 제공되는 <code>root</code>계정은 사용하지 않는 것을 보안상 추천합니다. 따라서 우리는 <code>sudo</code>권한을 가진 <code>django</code>라는 유저를 생성하고 Fabric으로 진행해 보겠습니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adduser django <span class="comment"># `django`라는 유저를 만듭니다.</span></span><br><span class="line">adduser django sudo <span class="comment"># django유저를 `sudo`그룹에 추가합니다.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>비밀번호를 만드는 것을 제외하면 나머지는 빈칸으로 만들어 두어도 무방합니다.</p>
</blockquote>
<h2 id="Fabric-설치하기"><a href="#Fabric-설치하기" class="headerlink" title="Fabric 설치하기"></a>Fabric 설치하기</h2><p><code>Fabric</code>은 기본적으로 서버가 아닌 클라이언트에 설치합니다. 개념상 로컬에서 SSH로 서버에 접속해 명령을 처리하는 것이기 때문에 당연히 SSH 명령을 입려하는 로컬에 설치되어야 합니다.</p>
<p>Fabric은 공식적으로는 Python2.7만을 지원합니다. 하지만 이 프로젝트를 Fork해서 Python3을 지원하는 프로젝트인 <code>Fabric3</code>이 있습니다. 이번 가이드에서는 이 <code>Fabric3</code>을 설치합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 install fabric3</span><br><span class="line"><span class="comment"># 혹은</span></span><br><span class="line">python3 -m pip install fabric3</span><br></pre></td></tr></table></figure>

<h2 id="fabfile-만들기"><a href="#fabfile-만들기" class="headerlink" title="fabfile 만들기"></a>fabfile 만들기</h2><h3 id="Fabric-import하기"><a href="#Fabric-import하기" class="headerlink" title="Fabric import하기"></a>Fabric import하기</h3><p>Fabric을 설치하시면 <code>fab</code>이라는 명령어를 사용할 수 있습니다. 이 명령어는 <code>fab some_func</code>라는 방식을 통해 <code>fabfile.py</code>파일 안의 함수를 실행할 수 있습니다.</p>
<p>fabfile은 기본적으로 <code>manage.py</code>파일와 같은 위치인 프로젝트 폴더에 두시는 것을 권장합니다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> append, exists, sed, put</span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> env, local, run, sudo</span><br></pre></td></tr></table></figure>

<p>우선 fabric에서 사용하는 API들을 import해줍니다.</p>
<p><code>fabric.contrib.files</code>에서는 원격(혹은 로컬)의 파일을 관리하는 API입니다. <code>fabric.api</code>는 Fabric에서 사용하는 환경이나, SSH로 연결한 원격 서버에서 명령어를 실행하는 API입니다.</p>
<h3 id="PROJECT-DIR-BASE-DIR-지정하기"><a href="#PROJECT-DIR-BASE-DIR-지정하기" class="headerlink" title="PROJECT_DIR, BASE_DIR 지정하기"></a>PROJECT_DIR, BASE_DIR 지정하기</h3><p>장고의 <code>settings.py</code>파일에 기본적으로 지정된 <code>BASE_DIR</code>와 같은 장고 프로젝트의 폴더 위치를 지정하는 <code>PROJECT_DIR</code>와 <code>BASE_DIR</code>을 지정해 줍니다.</p>
<p><code>PROJECT_DIR</code>은 <code>settings.py</code>가 있는 폴더의 위치이고, <code>BASE_DIR</code>은 <code>manage.py</code>가 있는 폴더입니다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> append, exists, sed, put</span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> env, local, run, sudo</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">PROJECT_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">BASE_DIR = os.path.dirname(PROJECT_DIR)</span><br></pre></td></tr></table></figure>

<h3 id="배포용-변수-불러오기"><a href="#배포용-변수-불러오기" class="headerlink" title="배포용 변수 불러오기"></a>배포용 변수 불러오기</h3><p>서버에 배포를 하기 위해 <code>git</code>을 이용합니다. 따라서 소스가 올라가 있는 깃헙(혹은 gitlab, bitbucket 등)의 주소(<code>REPO_URL</code>)가 필요합니다.</p>
<p>그리고 원격으로 SSH접속을 하기 때문에 원격 서버에 접속할 수 있는 SSH용 주소(<code>REMOTE_HOST_SSH</code>), 원격 계정 ID(<code>REMOTE_USER</code>), 원격 계정 비밀번호(<code>REMOTE_PASSWORD</code>)가 필요합니다.</p>
<p>또한, 장고 <code>settings.py</code>의 <code>ALLOWED_HOSTS</code>에 추가할 도메인(<code>REMOTE_HOST</code>)이 필요합니다.</p>
<p>이러한 변수들은 보통 json파일에 저장하고 <code>.gitignore</code>에 이 json파일을 지정해 git에 올라가지 않도록 관리합니다. 이번 가이드에서는 <code>deploy.json</code>이라는 파일에 아래 변수들을 저장하고 관리해 보겠습니다.</p>
<p><code>deploy.json</code>파일을 <code>fabfile.py</code>파일이 있는 곳에 아래 내용을 담고 저장해주세요.</p>
<blockquote>
<p><code>REPO_URL</code>와 <code>PROJECT_NAME</code>을 제외한 설정은 위 Vultr에서 만들어준 대로 진행해주세요. 단, REMOTE_USER는 root이면 안됩니다!</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"REPO_URL"</span>:<span class="string">"https://github.com/Beomi/irkshop.git"</span>,</span><br><span class="line">  <span class="attr">"PROJECT_NAME"</span>:<span class="string">"irkshop"</span>,</span><br><span class="line">  <span class="attr">"REMOTE_HOST_SSH"</span>:<span class="string">"45.77.20.73"</span>,</span><br><span class="line">  <span class="attr">"REMOTE_HOST"</span>:<span class="string">"45.77.20.73"</span>,</span><br><span class="line">  <span class="attr">"REMOTE_USER"</span>:<span class="string">"django"</span>,</span><br><span class="line">  <span class="attr">"REMOTE_PASSWORD"</span>:<span class="string">"django_pwd123"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>만약 SSH 포트가 다르다면 <code>REMOTE_HOST_SSH</code> 뒤 포트를 :으로 붙여주면 됩니다. (ex: 45.77.20.73:22)</p>
</blockquote>
<blockquote>
<p>REMOTE_HOST는 도메인 주소(ex: irkshop.testi.kr)일 수 있습니다. 하지만 이번 배포에서는 도메인을 다루지 않으므로 IP주소로 대신합니다.</p>
</blockquote>
<p>json파일을 만들었다면 이 파일을 이제 <code>fabfile.py</code>에서 불러와 사용해 봅시다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> append, exists, sed, put</span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> env, local, run, sudo</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">PROJECT_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># deploy.json파일을 불러와 envs변수에 저장합니다.</span></span><br><span class="line"><span class="keyword">with</span> open(os.path.join(PROJECT_DIR, <span class="string">"deploy.json"</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    envs = json.loads(f.read())</span><br><span class="line"></span><br><span class="line">REPO_URL = envs[<span class="string">'REPO_URL'</span>]</span><br><span class="line">PROJECT_NAME = envs[<span class="string">'PROJECT_NAME'</span>]</span><br><span class="line">REMOTE_HOST_SSH = envs[<span class="string">'REMOTE_HOST_SSH'</span>]</span><br><span class="line">REMOTE_HOST = envs[<span class="string">'REMOTE_HOST'</span>]</span><br><span class="line">REMOTE_USER = envs[<span class="string">'REMOTE_USER'</span>]</span><br><span class="line">REMOTE_PASSWORD = envs[<span class="string">'REMOTE_PASSWORD'</span>]</span><br><span class="line"><span class="comment"># 아래 부분은 Django의 settings.py에서 지정한 STATIC_ROOT 폴더 이름, STATID_URL, MEDIA_ROOT 폴더 이름을 입력해주시면 됩니다.</span></span><br><span class="line">STATIC_ROOT_NAME = <span class="string">'static_deploy'</span></span><br><span class="line">STATIC_URL_NAME = <span class="string">'static'</span></span><br><span class="line">MEDIA_ROOT = <span class="string">'uploads'</span></span><br></pre></td></tr></table></figure>

<h3 id="Fabric-환경-설정하기"><a href="#Fabric-환경-설정하기" class="headerlink" title="Fabric 환경 설정하기"></a>Fabric 환경 설정하기</h3><p>이제 Fabric이 사용할 <code>env</code>를 설정해 줍시다. 대표적으로 <code>env.user</code>와 <code>env.hosts</code>, <code>env.password</code>가 있습니다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> append, exists, sed, put</span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> env, local, run, sudo</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">PROJECT_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(os.path.join(PROJECT_DIR, <span class="string">"deploy.json"</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    envs = json.loads(f.read())</span><br><span class="line"></span><br><span class="line">REPO_URL = envs[<span class="string">'REPO_URL'</span>]</span><br><span class="line">PROJECT_NAME = envs[<span class="string">'PROJECT_NAME'</span>]</span><br><span class="line">REMOTE_HOST_SSH = envs[<span class="string">'REMOTE_HOST_SSH'</span>]</span><br><span class="line">REMOTE_HOST = envs[<span class="string">'REMOTE_HOST'</span>]</span><br><span class="line">REMOTE_USER = envs[<span class="string">'REMOTE_USER'</span>]</span><br><span class="line">REMOTE_PASSWORD = envs[<span class="string">'REMOTE_PASSWORD'</span>]</span><br><span class="line">STATIC_ROOT_NAME = <span class="string">'static_deploy'</span></span><br><span class="line">STATIC_URL_NAME = <span class="string">'static'</span></span><br><span class="line">MEDIA_ROOT = <span class="string">'uploads'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Fabric이 사용하는 env에 값들을 저장합니다.</span></span><br><span class="line">env.user = REMOTE_USER</span><br><span class="line">username = env.user</span><br><span class="line">env.hosts = [</span><br><span class="line">    REMOTE_HOST_SSH, <span class="comment"># 리스트로 만들어야 합니다.</span></span><br><span class="line">    ]</span><br><span class="line">env.password = REMOTE_PASSWORD</span><br><span class="line"><span class="comment"># 원격 서버에서 장고 프로젝트가 있는 위치를 정해줍니다.</span></span><br><span class="line">project_folder = <span class="string">'/home/&#123;&#125;/&#123;&#125;'</span>.format(env.user, PROJECT_NAME)</span><br></pre></td></tr></table></figure>

<p>이와 같이 설정시 <code>fab</code>명령어를 실행할 경우에 추가적인 값을 입력할 필요가 없어집니다.</p>
<h3 id="APT-설치-목록-지정하기"><a href="#APT-설치-목록-지정하기" class="headerlink" title="APT 설치 목록 지정하기"></a>APT 설치 목록 지정하기</h3><p>VPS에 따라 설치되어있는 리눅스 패키지가 다릅니다. 이번 가이드에서는 <code>Apache2</code>와 <code>mod-wsgi-py3</code>을 사용하기 때문에 이 패키지와 파이썬 의존 패키지들을 설치해 줘야 합니다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> append, exists, sed, put</span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> env, local, run, sudo</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">PROJECT_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(os.path.join(PROJECT_DIR, <span class="string">"deploy.json"</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    envs = json.loads(f.read())</span><br><span class="line"></span><br><span class="line">REPO_URL = envs[<span class="string">'REPO_URL'</span>]</span><br><span class="line">PROJECT_NAME = envs[<span class="string">'PROJECT_NAME'</span>]</span><br><span class="line">REMOTE_HOST_SSH = envs[<span class="string">'REMOTE_HOST_SSH'</span>]</span><br><span class="line">REMOTE_HOST = envs[<span class="string">'REMOTE_HOST'</span>]</span><br><span class="line">REMOTE_USER = envs[<span class="string">'REMOTE_USER'</span>]</span><br><span class="line">REMOTE_PASSWORD = envs[<span class="string">'REMOTE_PASSWORD'</span>]</span><br><span class="line">STATIC_ROOT_NAME = <span class="string">'static_deploy'</span></span><br><span class="line">STATIC_URL_NAME = <span class="string">'static'</span></span><br><span class="line">MEDIA_ROOT = <span class="string">'uploads'</span></span><br><span class="line"></span><br><span class="line">env.user = REMOTE_USER</span><br><span class="line">username = env.user</span><br><span class="line">env.hosts = [REMOTE_HOST_SSH,]</span><br><span class="line">env.password = REMOTE_PASSWORD</span><br><span class="line">project_folder = <span class="string">'/home/&#123;&#125;/&#123;&#125;'</span>.format(env.user, PROJECT_NAME)</span><br><span class="line"></span><br><span class="line"><span class="comment"># APT로 설치할 목록을 정해줍니다.</span></span><br><span class="line">apt_requirements = [</span><br><span class="line">    <span class="string">'ufw'</span>, <span class="comment"># 방화벽</span></span><br><span class="line">    <span class="string">'curl'</span>,</span><br><span class="line">    <span class="string">'git'</span>, <span class="comment"># 깃</span></span><br><span class="line">    <span class="string">'python3-dev'</span>, <span class="comment"># Python 의존성</span></span><br><span class="line">    <span class="string">'python3-pip'</span>, <span class="comment"># PIP</span></span><br><span class="line">    <span class="string">'build-essential'</span>, <span class="comment"># C컴파일 패키지</span></span><br><span class="line">    <span class="string">'python3-setuptools'</span>, <span class="comment"># PIP</span></span><br><span class="line">    <span class="string">'apache2'</span>, <span class="comment"># 웹서버 Apache2</span></span><br><span class="line">    <span class="string">'libapache2-mod-wsgi-py3'</span>, <span class="comment"># 웹서버~Python3 연결</span></span><br><span class="line">    <span class="comment"># 'libmysqlclient-dev', # MySql</span></span><br><span class="line">    <span class="string">'libssl-dev'</span>, <span class="comment"># SSL</span></span><br><span class="line">    <span class="string">'libxml2-dev'</span>, <span class="comment"># XML</span></span><br><span class="line">    <span class="string">'libjpeg8-dev'</span>, <span class="comment"># Pillow 의존성 패키지(ImageField)</span></span><br><span class="line">    <span class="string">'zlib1g-dev'</span>, <span class="comment"># Pillow 의존성 패키지</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="Fab-함수-만들기"><a href="#Fab-함수-만들기" class="headerlink" title="Fab 함수 만들기"></a>Fab 함수 만들기</h3><p>Fabric은 fabfile있는 곳에서 <code>fab 함수이름</code>의 명령어로 실행 가능합니다. 단, <code>_</code>로 시작하는 함수는 Fabric이 관리하지 않습니다.</p>
<p>이제 서버에서 실행할 SSH를 캡슐화한다고 보면 됩니다. 크게 <code>setup</code>와 <code>deploy</code>로 나눌 수 있다고 봅니다. Setup은 장고 코드와 무관한 OS의 패키지 관리와 VirtualEnv관리, Deploy는 장고 소스가 변화할 경우 업데이트 되어야 하는 코드입니다.</p>
<p>Setup에는 APT 최신 패키지 설치와 <code>apt_requirements</code>설치, 그리고 <code>virtualenv</code>를 만드는 것까지를 다룹니다.</p>
<p>Deploy에서는 Git에서 최신 소스코드를 가져오고, Git에서 관리되지 않는 환경변수 파일을 서버에 업로드하고, 장고 <code>settings.py</code>파일을 상용 환경으로 바꿔주고, virtualenv로 만든 가상환경에 pip 패키지를 설치하고, StaticFile들을 collect하고, DB를 migrate해주고, Apache2의 VirtualHost에 장고 웹 서비스를 등록하고, 폴더 권한을 잡아주고, 마지막으로 Apache2 웹서버를 재부팅하는 과정까지를 다룹니다.</p>
<blockquote>
<p>여기서부터는 코드가 너무 길어지는 관계로 <code>apt_requirements</code> 포함한 윗부분을 생략합니다. </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 앞부분 생략</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_server</span><span class="params">()</span>:</span></span><br><span class="line">    setup()</span><br><span class="line">    deploy()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">()</span>:</span></span><br><span class="line">    _get_latest_apt() <span class="comment"># APT update/upgrade</span></span><br><span class="line">    _install_apt_requirements(apt_requirements) <span class="comment"># APT install</span></span><br><span class="line">    _make_virtualenv() <span class="comment"># Virtualenv</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deploy</span><span class="params">()</span>:</span></span><br><span class="line">    _get_latest_source() <span class="comment"># Git에서 최신 소스 가져오기</span></span><br><span class="line">    _put_envs() <span class="comment"># 환경변수 json파일 업로드</span></span><br><span class="line">    _update_settings() <span class="comment"># settings.py파일 변경</span></span><br><span class="line">    _update_virtualenv() <span class="comment"># pip 설치</span></span><br><span class="line">    _update_static_files() <span class="comment"># collectstatics</span></span><br><span class="line">    _update_database() <span class="comment"># migrate</span></span><br><span class="line">    _make_virtualhost() <span class="comment"># Apache2 VirtualHost</span></span><br><span class="line">    _grant_apache2() <span class="comment"># chmod</span></span><br><span class="line">    _grant_sqlite3() <span class="comment"># chmod</span></span><br><span class="line">    _restart_apache2() <span class="comment"># 웹서버 재시작</span></span><br></pre></td></tr></table></figure>

<p>이와 같이 함수를 등록해주면 <code>fab new_server</code>, <code>fab setup</code>, <code>fab deploy</code>를 통해 바로바로 배포를 할 수 있습니다.</p>
<p>이제 <code>_</code>로 시작하는, 진짜 Fabric함수들을 만들어 보겠습니다.</p>
<blockquote>
<p>_ 로 시작하는 함수들을 설명할 때는 함수만 각각 설명합니다. 모두 모인 코드는 글 상단의 GIST를 참고해주세요.</p>
</blockquote>
<ul>
<li><code>_get_latest_apt</code>: APT 업데이트 &amp; 업그레이드</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_latest_apt</span><span class="params">()</span>:</span></span><br><span class="line">    update_or_not = input(<span class="string">'would you update?: [y/n]'</span>)</span><br><span class="line">    <span class="keyword">if</span> update_or_not==<span class="string">'y'</span>:</span><br><span class="line">        sudo(<span class="string">'sudo apt-get update &amp;&amp; sudo apt-get -y upgrade'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_install_apt_requirements</code>: apt_requirements에 적은 패키지들을 설치합니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_install_apt_requirements</span><span class="params">(apt_requirements)</span>:</span></span><br><span class="line">    reqs = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> req <span class="keyword">in</span> apt_requirements:</span><br><span class="line">        reqs += (<span class="string">' '</span> + req)</span><br><span class="line">    sudo(<span class="string">'sudo apt-get -y install &#123;&#125;'</span>.format(reqs))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_make_virtualenv</code>: 원격 서버에 <code>~/.virtualenvs</code>폴더가 없는 경우 virtualenv와 virtualenvwrapper를 설치하고 <code>.bashrc</code>파일에 virtualenvwrapper를 등록해 줍니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_make_virtualenv</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exists(<span class="string">'~/.virtualenvs'</span>):</span><br><span class="line">        script = <span class="string">'''"# python virtualenv settings</span></span><br><span class="line"><span class="string">                    export WORKON_HOME=~/.virtualenvs</span></span><br><span class="line"><span class="string">                    export VIRTUALENVWRAPPER_PYTHON="$(command \which python3)"  # location of python3</span></span><br><span class="line"><span class="string">                    source /usr/local/bin/virtualenvwrapper.sh"'''</span></span><br><span class="line">        run(<span class="string">'mkdir ~/.virtualenvs'</span>)</span><br><span class="line">        sudo(<span class="string">'sudo pip3 install virtualenv virtualenvwrapper'</span>)</span><br><span class="line">        run(<span class="string">'echo &#123;&#125; &gt;&gt; ~/.bashrc'</span>.format(script))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_get_latest_source</code>: 만약 <code>.git</code>폴더가 없다면 원격 git repo에서 clone해오고, 있다면 fetch해온 후 최신 커밋으로 reset합니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_latest_source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> exists(project_folder + <span class="string">'/.git'</span>):</span><br><span class="line">        run(<span class="string">'cd %s &amp;&amp; git fetch'</span> % (project_folder,))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        run(<span class="string">'git clone %s %s'</span> % (REPO_URL, project_folder))</span><br><span class="line">    current_commit = local(<span class="string">"git log -n 1 --format=%H"</span>, capture=<span class="literal">True</span>)</span><br><span class="line">    run(<span class="string">'cd %s &amp;&amp; git reset --hard %s'</span> % (project_folder, current_commit))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_put_envs</code>: 로컬의 <code>envs.json</code>이름의 환경변수를 서버에 업로드 합니다.</li>
</ul>
<blockquote>
<p>Apache2는 웹서버가 OS의 환경변수를 사용하지 않기 때문에 json와 같은 파일을 통해 환경변수를 관리해 줘야 합니다. 저는 <code>envs.json</code>이라는 파일을 <code>manage.py</code>파일이 있는 프로젝트 폴더에 만든 후 환경변수를 장고의 <code>settings.py</code>에서 불러와 사용합니다.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_put_envs</span><span class="params">()</span>:</span></span><br><span class="line">    put(os.path.join(PROJECT_DIR, <span class="string">'envs.json'</span>), <span class="string">'~/&#123;&#125;/envs.json'</span>.format(PROJECT_NAME))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_update_settings</code>: <code>settings.py</code>파일을 바꿔줍니다. DEBUG를 False로 바꾸고, ALLOWED_HOSTS에 호스트 이름을 등록하고, 장고에서 만들어준 키 파일이 아니라 서버에서 랜덤으로 만든 Secret KEY를 사용하게 합니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_update_settings</span><span class="params">()</span>:</span></span><br><span class="line">    settings_path = project_folder + <span class="string">'/&#123;&#125;/settings.py'</span>.format(PROJECT_NAME)</span><br><span class="line">    sed(settings_path, <span class="string">"DEBUG = True"</span>, <span class="string">"DEBUG = False"</span>)</span><br><span class="line">    sed(settings_path,</span><br><span class="line">        <span class="string">'ALLOWED_HOSTS = .+$'</span>,</span><br><span class="line">        <span class="string">'ALLOWED_HOSTS = ["%s"]'</span> % (REMOTE_HOST,)</span><br><span class="line">    )</span><br><span class="line">    secret_key_file = project_folder + <span class="string">'/&#123;&#125;/secret_key.py'</span>.format(PROJECT_NAME)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exists(secret_key_file):</span><br><span class="line">        chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*(-_=+)'</span></span><br><span class="line">        key = <span class="string">''</span>.join(random.SystemRandom().choice(chars) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">50</span>))</span><br><span class="line">        append(secret_key_file, <span class="string">"SECRET_KEY = '%s'"</span> % (key,))</span><br><span class="line">    append(settings_path, <span class="string">'\nfrom .secret_key import SECRET_KEY'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_update_virtualenv</code>: virtualenv에 <code>requirements.txt</code>파일로 지정된 pip 패키지들을 설치합니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_update_virtualenv</span><span class="params">()</span>:</span></span><br><span class="line">    virtualenv_folder = project_folder + <span class="string">'/../.virtualenvs/&#123;&#125;'</span>.format(PROJECT_NAME)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exists(virtualenv_folder + <span class="string">'/bin/pip'</span>):</span><br><span class="line">        run(<span class="string">'cd /home/%s/.virtualenvs &amp;&amp; virtualenv %s'</span> % (env.user, PROJECT_NAME))</span><br><span class="line">    run(<span class="string">'%s/bin/pip install -r %s/requirements.txt'</span> % (</span><br><span class="line">        virtualenv_folder, project_folder</span><br><span class="line">    ))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_update_static_files</code>: CollectStatic을 해줍니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_update_static_files</span><span class="params">()</span>:</span></span><br><span class="line">    virtualenv_folder = project_folder + <span class="string">'/../.virtualenvs/&#123;&#125;'</span>.format(PROJECT_NAME)</span><br><span class="line">    run(<span class="string">'cd %s &amp;&amp; %s/bin/python3 manage.py collectstatic --noinput'</span> % (</span><br><span class="line">        project_folder, virtualenv_folder</span><br><span class="line">    ))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_update_database</code>: DB migrate를 해줍니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_update_database</span><span class="params">()</span>:</span></span><br><span class="line">    virtualenv_folder = project_folder + <span class="string">'/../.virtualenvs/&#123;&#125;'</span>.format(PROJECT_NAME)</span><br><span class="line">    run(<span class="string">'cd %s &amp;&amp; %s/bin/python3 manage.py migrate --noinput'</span> % (</span><br><span class="line">        project_folder, virtualenv_folder</span><br><span class="line">    ))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_make_virtualhost</code>: Apache2가 관리하는 VirtualHost를 만들어줍니다. 80포트로 지정하고 Static파일을 Apache2가 서빙합니다.</li>
</ul>
<blockquote>
<p>만약 SSL을 사용하고 싶으시다면 *:443으로 관리되는 파일을 추가적으로 만드셔야 합니다. 이번 가이드에서는 다루지 않습니다.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_make_virtualhost</span><span class="params">()</span>:</span></span><br><span class="line">    script = <span class="string">"""'&lt;VirtualHost *:80&gt;</span></span><br><span class="line"><span class="string">    ServerName &#123;servername&#125;</span></span><br><span class="line"><span class="string">    Alias /&#123;static_url&#125; /home/&#123;username&#125;/&#123;project_name&#125;/&#123;static_root&#125;</span></span><br><span class="line"><span class="string">    Alias /&#123;media_url&#125; /home/&#123;username&#125;/&#123;project_name&#125;/&#123;media_url&#125;</span></span><br><span class="line"><span class="string">    &lt;Directory /home/&#123;username&#125;/&#123;project_name&#125;/&#123;media_url&#125;&gt;</span></span><br><span class="line"><span class="string">        Require all granted</span></span><br><span class="line"><span class="string">    &lt;/Directory&gt;</span></span><br><span class="line"><span class="string">    &lt;Directory /home/&#123;username&#125;/&#123;project_name&#125;/&#123;static_root&#125;&gt;</span></span><br><span class="line"><span class="string">        Require all granted</span></span><br><span class="line"><span class="string">    &lt;/Directory&gt;</span></span><br><span class="line"><span class="string">    &lt;Directory /home/&#123;username&#125;/&#123;project_name&#125;/&#123;project_name&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;Files wsgi.py&gt;</span></span><br><span class="line"><span class="string">            Require all granted</span></span><br><span class="line"><span class="string">        &lt;/Files&gt;</span></span><br><span class="line"><span class="string">    &lt;/Directory&gt;</span></span><br><span class="line"><span class="string">    WSGIDaemonProcess &#123;project_name&#125; python-home=/home/&#123;username&#125;/.virtualenvs/&#123;project_name&#125; python-path=/home/&#123;username&#125;/&#123;project_name&#125;</span></span><br><span class="line"><span class="string">    WSGIProcessGroup &#123;project_name&#125;</span></span><br><span class="line"><span class="string">    WSGIScriptAlias / /home/&#123;username&#125;/&#123;project_name&#125;/&#123;project_name&#125;/wsgi.py</span></span><br><span class="line"><span class="string">    &#123;% raw %&#125;</span></span><br><span class="line"><span class="string">    ErrorLog $&#123;&#123;APACHE_LOG_DIR&#125;&#125;/error.log</span></span><br><span class="line"><span class="string">    CustomLog $&#123;&#123;APACHE_LOG_DIR&#125;&#125;/access.log combined</span></span><br><span class="line"><span class="string">    &#123;% endraw %&#125;</span></span><br><span class="line"><span class="string">    &lt;/VirtualHost&gt;'"""</span>.format(</span><br><span class="line">        static_root=STATIC_ROOT_NAME,</span><br><span class="line">        username=env.user,</span><br><span class="line">        project_name=PROJECT_NAME,</span><br><span class="line">        static_url=STATIC_URL_NAME,</span><br><span class="line">        servername=REMOTE_HOST,</span><br><span class="line">        media_url=MEDIA_ROOT</span><br><span class="line">    )</span><br><span class="line">    sudo(<span class="string">'echo &#123;&#125; &gt; /etc/apache2/sites-available/&#123;&#125;.conf'</span>.format(script, PROJECT_NAME))</span><br><span class="line">    sudo(<span class="string">'a2ensite &#123;&#125;.conf'</span>.format(PROJECT_NAME))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_grant_apache2</code>: 프로젝트 폴더내 파일을 <code>www-data</code>그룹(Apache2)이 관리할 수 있도록 소유권을 변경합니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_grant_apache2</span><span class="params">()</span>:</span></span><br><span class="line">    sudo(<span class="string">'sudo chown -R :www-data ~/&#123;&#125;'</span>.format(PROJECT_NAME))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_grant_sqlite3</code>: 만약 Sqlite3을 그대로 이용할 경우 <code>www-data</code>가 쓰기 권한을 가져야 합니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_grant_sqlite3</span><span class="params">()</span>:</span></span><br><span class="line">    sudo(<span class="string">'sudo chmod 775 ~/&#123;&#125;/db.sqlite3'</span>.format(PROJECT_NAME))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_restart_apache2</code>: 모든 설정을 마친 후 Apache2 웹서버를 재실행해 설정을 적용해줍니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_restart_apache2</span><span class="params">()</span>:</span></span><br><span class="line">    sudo(<span class="string">'sudo service apache2 restart'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="배포해보기"><a href="#배포해보기" class="headerlink" title="배포해보기"></a>배포해보기</h2><p>이제 <code>manage.py</code>파일이 있는 곳에서 아래 명령어를 입력해 봅시다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fab new_server</span><br></pre></td></tr></table></figure>

<p>이 명령어를 치면 자동으로 모든 과정이 완료되고 서버가 뜹니다.</p>
<p>만약 파일을 수정하고 커밋했다면, Github Repo에 올린 후 <code>deploy</code> 명령어를 통해 새 코드를 서버에 배포할 수 있습니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fab deploy</span><br></pre></td></tr></table></figure>

<h2 id="짜잔"><a href="#짜잔" class="headerlink" title="짜잔!"></a>짜잔!</h2><p>프로젝트 하나가 배포가 완료되었습니다! 아무것도 없어보이지만, DB에 자료를 추가하면 <a href="http://irkshop.testi.kr">IRKSHOP 예제</a>처럼 예쁘게 생성됩니다.</p>
<p><img src="https://d1sr4ybm5bj1wl.cloudfront.net/img/dropbox/2017-03-20%2000.28.56.png" alt="Simple IRKSHOP"></p>

        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2017/03/20/Using-ES6-JSX-on-Client/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">React+JSX(ES6)를 빌드 없이 사용하기: browser.js</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2017/03/19/Celery-Getting-Started/">
                <span class="level-item">[번역]셀러리: 시작하기</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                
                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    Beomi&#39;s Tech Blog
                
                </a>
                <p class="is-size-7">
                &copy; 2021 Junbum Lee&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("ko");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://beomi.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="Kembali ke atas" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>








<script src="/js/main.js" defer></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

    
</body>
</html>